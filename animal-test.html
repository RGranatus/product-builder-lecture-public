<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>동물상 테스트</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>동물상 테스트</h1>
        <p class="subtitle">나는 어떤 동물과 닮았을까?</p>
        <div id="status" style="margin-top: 20px; font-weight: bold;"></div>
        <button type="button" class="main" onclick="init()">시작하기</button>
        <div class="result-container">
            <div id="webcam-container"></div>
            <div id="label-container" class="label-container"></div>
        </div>
    </div>
    <div class="container" style="text-align: center; margin-top: 20px;">
        <a href="index.html">로또 번호 생성기로 돌아가기</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachable-machine-image.min.js"></script>
    <script type="text/javascript">
        const URL = "https://teachablemachine.withgoogle.com/models/yvJn2POqH/";
        let model, webcam, labelContainer, maxPredictions;
        const statusDiv = document.getElementById("status");
        let initCalled = false;

        document.addEventListener("DOMContentLoaded", function() {
            statusDiv.innerHTML = "페이지 로드 완료. 라이브러리 확인 중...";
            console.log("DOM Content Loaded. Checking libraries...");

            setTimeout(() => {
                const isTmImageDefined = typeof window.tmImage !== 'undefined';
                const isTfDefined = typeof window.tf !== 'undefined';
                console.log(`window.tmImage defined: ${isTmImageDefined}`);
                console.log(`window.tf defined: ${isTfDefined}`);

                if (!isTmImageDefined || !isTfDefined) {
                    statusDiv.innerHTML = "오류: Teachable Machine 또는 TensorFlow 라이브러리가 로드되지 않았습니다. 개발자 콘솔을 확인하여 네트워크 오류를 확인하십시오.";
                    document.querySelector('button').disabled = true;
                    console.error("Critical Error: tmImage or tf library not loaded. Please check network requests in browser developer console for errors (e.g., failed to load script, CORS issues).");
                } else {
                    statusDiv.innerHTML = "라이브러리 로드 완료. '시작하기' 버튼을 누르세요.";
                    console.log("Teachable Machine and TensorFlow libraries loaded. Ready to initialize.");
                    document.querySelector('button').onclick = function() {
                        if (!initCalled) {
                            init();
                            initCalled = true;
                        }
                    };
                }
            }, 1500);
        });


        async function init() {
            try {
                document.querySelector('button').style.display = 'none';
                statusDiv.innerHTML = "모델을 불러오는 중입니다...";
                console.log("Initializing: Loading model...");

                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";

                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
                statusDiv.innerHTML = "웹캠을 준비하는 중입니다...";
                console.log("Model loaded. Setting up webcam...");

                const flip = true;
                webcam = new tmImage.Webcam(400, 400, flip);
                await webcam.setup();
                await webcam.play();
                statusDiv.innerHTML = "준비 완료! 예측 시작...";
                console.log("Webcam ready. Starting prediction loop.");
                window.requestAnimationFrame(loop);

                document.getElementById("webcam-container").appendChild(webcam.canvas);
                labelContainer = document.getElementById("label-container");
                for (let i = 0; i < maxPredictions; i++) {
                    labelContainer.appendChild(document.createElement("div"));
                }
            } catch (e) {
                console.error("Error during initialization:", e);
                statusDiv.innerHTML = "오류가 발생했습니다: " + e.message + ". 개발자 콘솔을 확인하십시오.";
            }
        }

        async function loop() {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction =
                    prediction[i].className + ": " + prediction[i].probability.toFixed(2);
                labelContainer.childNodes[i].innerHTML = classPrediction;
            }
        }
    </script>
</body>
</html>